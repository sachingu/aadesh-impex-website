name: Deploy to Cloud Run (from source)

on:
  push:
    branches:
      - main

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  deploy:
    name: Build & Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Validate GCP Workload Identity secrets
        run: |
          # Secrets are not available for workflows triggered from forks.
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "Error: running from a pull_request; repository secrets may be unavailable (forks).";
            echo "Trigger workflow from the repository (push to main) or run locally.";
            exit 1;
          fi

          if [ -z "${{ secrets.GCP_WIF_PROVIDER }}" ]; then
            echo "Missing secret: GCP_WIF_PROVIDER";
            exit 1;
          fi
          if [ -z "${{ secrets.GCP_SA_EMAIL }}" ]; then
            echo "Missing secret: GCP_SA_EMAIL";
            exit 1;
          fi
          if [ -z "${{ secrets.GCP_PROJECT }}" ]; then
            echo "Missing secret: GCP_PROJECT";
            exit 1;
          fi
        shell: bash

      - name: Build client + server artifacts
        run: npm run build

      - name: Authenticate to GCP (Workload Identity)
        uses: google-github-actions/auth@v1
        with:
          # The Workload Identity Provider resource (create in GCP IAM)
          # e.g. "projects/12345/locations/global/workloadIdentityPools/POOL/providers/PROVIDER"
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          # The service account email to impersonate, e.g. my-sa@project.iam.gserviceaccount.com
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT }}
          version: 'latest'

      - name: Deploy to Cloud Run from source
        env:
          CLOUD_RUN_SERVICE: ${{ secrets.CLOUD_RUN_SERVICE }}
          CLOUD_RUN_REGION: ${{ secrets.CLOUD_RUN_REGION }}
          CLOUDSQL_INSTANCE: ${{ secrets.CLOUDSQL_INSTANCE }}
        run: |
          # Deploys by building the repository into a container (Cloud Build)
          # and deploying that container to Cloud Run.
          gcloud run deploy "$CLOUD_RUN_SERVICE" \
            --source . \
            --region "$CLOUD_RUN_REGION" \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "NODE_ENV=production,DATABASE_URL=${{ secrets.DATABASE_URL }},SMTP_HOST=${{ secrets.SMTP_HOST }},SMTP_PORT=${{ secrets.SMTP_PORT }},SMTP_USER=${{ secrets.SMTP_USER }},SMTP_PASS=${{ secrets.SMTP_PASS }},EMAIL_TO=${{ secrets.EMAIL_TO }}" \
            --add-cloudsql-instances "$CLOUDSQL_INSTANCE"

      - name: Post-deploy note
        run: echo "Deployment finished. Verify Cloud Run service in GCP console."
